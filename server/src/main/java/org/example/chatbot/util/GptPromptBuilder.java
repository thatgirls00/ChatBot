package org.example.chatbot.util;

/**
 * GPT에게 전달할 프롬프트 문자열을 생성하는 유틸리티 클래스입니다.
 * 사용자 입력을 먼저 정제한 뒤, intent 및 keyword를 추출하기 위한 프롬프트를 단계별로 생성합니다.
 */
public class GptPromptBuilder {

    /**
     * 1단계: 사용자 입력을 구어체/비속어 등에서 정제된 한국어 문장으로 바꾸는 프롬프트
     */
    public static String buildNormalizePrompt(String rawUserInput) {
        return """
        너는 한경국립대학교의 학식 및 학교정보 챗봇에서 사용자 입력을 정제해주는 역할을 맡고 있어.

        사용자들은 주로 모바일로 빠르게 타이핑하므로,  
        구어체, 비속어, 영어, 줄임말, 띄어쓰기 오류, 맞춤법 오류가 많아.  
        하지만 너는 이 모든 입력을 잘 이해해서 의미가 명확한 **짧고 간결한 한국어 문장**으로 고쳐야 해.

        ### ✏️ 정제 규칙:
        - 공손한 말투, 욕설, 감탄사는 제거해.
        - 질문의 핵심 의미만 남기고 간단히 요약해.
        - 키워드(수강신청, 돈까스 등)는 반드시 유지해.
        - JSON, 마크다운 없이 한 문장만 출력해.

        ### 예시:
        - "수강 언제함??" → 수강신청 일정 알려줘
        - "야 학식 뭐나옴?" → 학생식당 메뉴 알려줘
        - "등록금 언제까지임" → 등록금 납부 마감일 알려줘
        - "졸업 언제냐 진짜" → 졸업일정 알려줘

        사용자 질문:
        "%s"
        """.formatted(rawUserInput);
    }

    /**
     * 2단계: 정제된 문장에서 intent와 keyword를 추출하는 프롬프트
     */
    public static String buildClassifyPrompt(String normalizedInput) {
        return """
        너는 한경국립대학교 챗봇 시스템의 정보 추출기야.  
        사용자의 질문을 분석해서 반드시 아래 2가지를 JSON 형식으로 정확히 추출해.

        1. intent: 다음 목록 중 하나로만 반환해.
        - intent는 학사공지, 학사일정, 학생식당, 기숙사식당, 교직원식당, 한경공지, 장학공지, 식당 미지정, 전체공지, 없음 으로만
        - intent는 반드시 위 목록 중 하나로만 반환하고, 다른 단어나 문장을 절대 포함하지 마.
        
            📌 intent 분류 규칙:
                - "전체", "모든", "전부", "다" + "공지"가 함께 포함된 경우 반드시 '전체공지'로 분류
                - “공지” 또는 “공지사항”이라는 단어가 포함되어 있다면 반드시 공지(intent = 학사공지/장학공지/한경공지/전체공지 중 하나)로 분류하라.
                - "오늘 전체 공지", "이번주 전체 공지", "전체공지 알려줘" 등은 전부 intent='전체공지'
                - 질문에 식당명(학생식당, 기숙사식당, 교직원식당)이 포함되면 intent는 반드시 해당 식당명으로 지정해야 해.
                - 질문에 '일정'이라는 단어가 포함되어 있으면 intent는 무조건 '학사일정'으로 지정해야 해.
                - 질문이 음식이나 식단에 대한 내용인데 식당명이 없다면 '식당 미지정'으로 지정해.
                - 공지 종류가 불명확하면 '없음'으로 지정해.

        2. keyword: 아래 항목 중 있으면 간단히 추출. 없으면 null
        - keyword는 intent와 중복되면 안 돼. intent에 들어간 식당명/공지명은 keyword로 지정하지 마.
        - 공지 키워드: 휴학, 등록금, 졸업, 학위수여, 수강신청, 시험, 축제, 개강, 종강, 계절수업, 등록기간, 전과, 체육대회, 수강철회, 수업일수, 장바구니, OT, 교외장학금, 국가근로, 한국장학재단, 국가보훈부
        - 음식 키워드: 제육볶음, 돈까스 등

        ⛔ 출력 형식은 JSON만 가능. 절대 다른 텍스트 포함 금지

        예시1:
        {
          "intent": "장학공지",
          "keyword": "등록금"
        }

        예시2:
        {
          "intent": "기숙사식당",
          "keyword": "돈까스"
        }

        예시3:
        {
          "intent": "식당 미지정",
          "keyword": null
        }
        
        예시5:
        {
          "intent": "전체공지",
          "keyword": "오늘"
        }

        사용자 질문:
        "%s"
        """.formatted(normalizedInput);
    }

    /**
     * Fallback 응답: 의도 분류 실패 또는 테이블 매칭 실패 시
     */
    public static String buildFallbackPrompt(String userInput) {
        return """
        다음은 사용자가 입력한 질문입니다:
        "%s"

        이 질문은 우리 데이터베이스에 등록된 정보와 직접적으로 관련이 없기 때문에,
        친절하고 간결한 설명으로 답변해줘.

        사용자가 한경국립대학교 학생임을 고려해 학내 정보, 주변 시설, 생활 편의 정보로 도움을 줘.
        """.formatted(userInput);
    }
}